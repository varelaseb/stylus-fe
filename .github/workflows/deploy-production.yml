name: Deploy Frontend Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-frontend-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
      DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
      DEPLOY_PORT: ${{ secrets.DEPLOY_PORT != '' && secrets.DEPLOY_PORT || '22' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare SSH
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          install -m 700 -d ~/.ssh
          printf '%s\n' "$DEPLOY_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p "$DEPLOY_PORT" -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts

      - name: Build deploy env file
        run: |
          {
            echo "VITE_MCP_SERVER_URL=${{ secrets.VITE_MCP_SERVER_URL }}"
            echo "VITE_SEARCH_API_URL=${{ secrets.VITE_SEARCH_API_URL }}"
            echo "VITE_OPENROUTER_PROXY_URL=${{ secrets.VITE_OPENROUTER_PROXY_URL }}"
            echo "VITE_LLM_SYSTEM_PROMPT=${{ secrets.VITE_LLM_SYSTEM_PROMPT }}"
            echo "VITE_LLM_MODEL=${{ secrets.VITE_LLM_MODEL }}"
            echo "VITE_LLM_FALLBACK_MODEL=${{ secrets.VITE_LLM_FALLBACK_MODEL }}"
            echo "VITE_PROJECT_GITHUB_URL=${{ secrets.VITE_PROJECT_GITHUB_URL }}"
            echo "VITE_PROJECT_X_URL=${{ secrets.VITE_PROJECT_X_URL }}"
          } > .deploy.env

      - name: Sync frontend files to server
        run: |
          rsync -az --delete \
            --exclude '.git/' \
            --exclude '.github/' \
            --exclude 'node_modules/' \
            --exclude 'dist/' \
            --exclude '.DS_Store' \
            -e "ssh -p $DEPLOY_PORT" \
            ./ "$DEPLOY_USER@$DEPLOY_HOST:/opt/stylus-frontend/"

      - name: Upload production env file
        run: |
          rsync -az \
            -e "ssh -p $DEPLOY_PORT" \
            .deploy.env "$DEPLOY_USER@$DEPLOY_HOST:/opt/stylus-frontend/.env"

      - name: Deploy with Docker Compose
        run: |
          ssh -p "$DEPLOY_PORT" "$DEPLOY_USER@$DEPLOY_HOST" <<'EOF'
          set -euo pipefail
          cd /opt/stylus-frontend
          docker compose -f compose.server.yml --env-file .env up -d --build --remove-orphans
          docker ps --format 'table {{.Names}}\t{{.Status}}' | sed -n '1,20p'
          EOF
